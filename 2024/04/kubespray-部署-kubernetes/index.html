<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Kubespray 部署 kubernetes - Linuzb&#39; 的博客</title><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="Kubespray 部署 kubernetes">
  <meta itemprop="description" content="准备 本文介绍中共使用了四台物理机, 其中一台用户部署 k8s 的机器，另外三台作为 kubernetes 的节点
机器 ip 系统 用户名 备注 部署机 任意 Ubuntu linuzb 部署k8s机器，非k8s集群节点 kube-master-100 172.16.0.100 Ubutnu linuzb 初始化 k8s master 节点 kube-node-117 172.16.0.117 Ubutnu linuzb 初始化 k8s node kube-node-114 172.16.0.114 Ubutnu linuzb 后续加入的 k8s node kubespray 配置 自定义配置 1 2 3 4 git clone https://github.com/kubernetes-sigs/kubespray cd kubespray # 拷贝集群清单 cp -rfp inventory/sample inventory/mycluster inventory inventory/mycluster/inventory.ini
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # ## Configure &#39;ip&#39; variable to bind kubernetes services on a # ## different ip than the default iface # ## We should set etcd_member_name for etcd cluster.">
  <meta itemprop="datePublished" content="2024-04-28T10:06:36+08:00">
  <meta itemprop="dateModified" content="2024-04-28T10:06:36+08:00">
  <meta itemprop="wordCount" content="640">
  <meta itemprop="keywords" content="Kubernetes,Kubespray"><meta property="og:url" content="https://linuzb.github.io/2024/04/kubespray-%E9%83%A8%E7%BD%B2-kubernetes/">
  <meta property="og:site_name" content="Linuzb&#39; 的博客">
  <meta property="og:title" content="Kubespray 部署 kubernetes">
  <meta property="og:description" content="准备 本文介绍中共使用了四台物理机, 其中一台用户部署 k8s 的机器，另外三台作为 kubernetes 的节点
机器 ip 系统 用户名 备注 部署机 任意 Ubuntu linuzb 部署k8s机器，非k8s集群节点 kube-master-100 172.16.0.100 Ubutnu linuzb 初始化 k8s master 节点 kube-node-117 172.16.0.117 Ubutnu linuzb 初始化 k8s node kube-node-114 172.16.0.114 Ubutnu linuzb 后续加入的 k8s node kubespray 配置 自定义配置 1 2 3 4 git clone https://github.com/kubernetes-sigs/kubespray cd kubespray # 拷贝集群清单 cp -rfp inventory/sample inventory/mycluster inventory inventory/mycluster/inventory.ini
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # ## Configure &#39;ip&#39; variable to bind kubernetes services on a # ## different ip than the default iface # ## We should set etcd_member_name for etcd cluster.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-28T10:06:36+08:00">
    <meta property="article:modified_time" content="2024-04-28T10:06:36+08:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Kubespray">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kubespray 部署 kubernetes">
  <meta name="twitter:description" content="准备 本文介绍中共使用了四台物理机, 其中一台用户部署 k8s 的机器，另外三台作为 kubernetes 的节点
机器 ip 系统 用户名 备注 部署机 任意 Ubuntu linuzb 部署k8s机器，非k8s集群节点 kube-master-100 172.16.0.100 Ubutnu linuzb 初始化 k8s master 节点 kube-node-117 172.16.0.117 Ubutnu linuzb 初始化 k8s node kube-node-114 172.16.0.114 Ubutnu linuzb 后续加入的 k8s node kubespray 配置 自定义配置 1 2 3 4 git clone https://github.com/kubernetes-sigs/kubespray cd kubespray # 拷贝集群清单 cp -rfp inventory/sample inventory/mycluster inventory inventory/mycluster/inventory.ini
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # ## Configure &#39;ip&#39; variable to bind kubernetes services on a # ## different ip than the default iface # ## We should set etcd_member_name for etcd cluster.">
<link rel="stylesheet" type="text/css" media="screen" href="https://linuzb.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://linuzb.github.io/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://linuzb.github.io/css/dark.css" />

	<script src="https://linuzb.github.io/js/feather.min.js"></script>
	
		<script src="https://linuzb.github.io/js/main.js"></script>
</head>


<body>


	
	<div class="container-wide wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://linuzb.github.io/">Linuzb&#39; 的博客</a></h1>
	<div class="site-description"><p>记录学习点滴</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/linuzb" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags &amp; Stats</a>
			</li>
			
		</ul>
	</nav>
</div>


		
<div class="article-nav" id="article-nav-id">
    <div class="post">
        <div class="post-header">
    
    <div class="meta">
        <div class="date">
            <span class="day">28</span>
            <span class="rest">Apr 2024</span>
        </div>
    </div>
    
    <div class="matter">
        <h1 class="title">Kubespray 部署 kubernetes</h1>
    </div>
</div>


        
        
        <aside class="toc" id="static-toc">
            <header>
                <h3>Contents</h3>
            </header>
            <nav id="TableOfContents">
  <ol>
    <li><a href="#准备">准备</a></li>
    <li><a href="#kubespray-配置">kubespray 配置</a>
      <ol>
        <li><a href="#自定义配置">自定义配置</a></li>
        <li><a href="#docker-部署">docker 部署</a></li>
        <li><a href="#后续">后续</a></li>
      </ol>
    </li>
    <li><a href="#debug">debug</a>
      <ol>
        <li><a href="#网络排查">网络排查</a></li>
      </ol>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ol>
</nav>
        </aside>
        

        <h2 id="准备">准备</h2>
<p>本文介绍中共使用了四台物理机, 其中一台用户部署 k8s 的机器，另外三台作为 kubernetes 的节点</p>
<table>
<thead>
<tr>
<th>机器</th>
<th>ip</th>
<th>系统</th>
<th>用户名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>部署机</td>
<td>任意</td>
<td>Ubuntu</td>
<td>linuzb</td>
<td>部署k8s机器，非k8s集群节点</td>
</tr>
<tr>
<td>kube-master-100</td>
<td>172.16.0.100</td>
<td>Ubutnu</td>
<td>linuzb</td>
<td>初始化 k8s master 节点</td>
</tr>
<tr>
<td>kube-node-117</td>
<td>172.16.0.117</td>
<td>Ubutnu</td>
<td>linuzb</td>
<td>初始化 k8s node</td>
</tr>
<tr>
<td>kube-node-114</td>
<td>172.16.0.114</td>
<td>Ubutnu</td>
<td>linuzb</td>
<td>后续加入的 k8s node</td>
</tr>
</tbody>
</table>
<h2 id="kubespray-配置">kubespray 配置</h2>
<h3 id="自定义配置">自定义配置</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes-sigs/kubespray
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 拷贝集群清单</span>
</span></span><span style="display:flex;"><span>cp -rfp inventory/sample inventory/mycluster
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="inventory">inventory</h4>
<p>inventory/mycluster/inventory.ini</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ## Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ## different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ## We should set etcd_member_name for etcd cluster. The node that is not a etcd member do not need to set the value, or can set the empty string value.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[all]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube-master-100 ansible_ssh_host</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">172.16.0.100 ansible_ssh_user=linuzb ip=172.16.0.100   mask=/24</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube-node-117 ansible_ssh_host</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">172.16.0.117 ansible_ssh_user=linuzb ip=172.16.0.117   mask=/24</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ## configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># [bastion]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># bastion ansible_host=x.x.x.x ansible_user=some_user</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[kube_control_plane]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube-master-100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[etcd]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube-master-100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[kube_node]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube-node-117</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[calico_rr]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[k8s_cluster:children]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube_control_plane</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">kube_node</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">calico_rr</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="集群网络">集群网络</h4>
<pre tabindex="0"><code>vim inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml
</code></pre><p>使用高性能的 cilium</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Choose network plugin (cilium, calico, kube-ovn, weave or flannel. Use cni for generic cni plugin)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic"># Can also be set to &#39;cloud&#39;, which lets the cloud provider setup appropriate routing</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">kube_network_plugin</span>:<span style="color:#bbb"> </span>cilium<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="运行时">运行时</h4>
<p>使用默认的 containerd
inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">## Container runtime</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">## docker for docker, crio for cri-o and containerd for containerd.</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">## Default: containerd</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">container_manager</span>:<span style="color:#bbb"> </span>containerd<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>容器运行目录(暂不修改)
inventory/mycluster/group_vars/all/containerd.yml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># containerd_storage_dir: &#34;/var/lib/containerd&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic"># containerd_state_dir: &#34;/run/containerd&#34;</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>配置容器registry(暂不配置，使用 dragonfly)</p>
<p>inventory/mycluster/group_vars/all/containerd.yml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">containerd_registries_mirrors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#000080">prefix</span>:<span style="color:#bbb"> </span>docker.io<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">mirrors</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#000080">host</span>:<span style="color:#bbb"> </span>http://hub-mirror.c.163.com<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">capabilities</span>:<span style="color:#bbb"> </span>[<span style="color:#d14">&#34;pull&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;resolve&#34;</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000080">skip_verify</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="集群配置">集群配置</h4>
<p>自动更新集群证书， 默认一年有效
inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">## Automatically renew K8S control plane certificates on first Monday of each month</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">auto_renew_certificates</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic"># Can be docker_dns, host_resolvconf or none</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">resolvconf_mode</span>:<span style="color:#bbb"> </span>none<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>打开日志报错</p>
<p>inventory/mycluster/group_vars/all/all.yml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#998;font-style:italic">## Used to control no_log attribute</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">unsafe_show_logs</span>:<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="镜像国内源">镜像国内源</h4>
<p><a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/mirror.md">kubespray/docs/mirror.md at master · kubernetes-sigs/kubespray (github.com)</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Use the download mirror</span>
</span></span><span style="display:flex;"><span>cp inventory/mycluster/group_vars/all/offline.yml inventory/mycluster/group_vars/all/mirror.yml
</span></span><span style="display:flex;"><span>sed -i -E <span style="color:#d14">&#39;/# .*\{\{ files_repo/s/^# //g&#39;</span> inventory/mycluster/group_vars/all/mirror.yml
</span></span><span style="display:flex;"><span>tee -a inventory/mycluster/group_vars/all/mirror.yml <span style="color:#d14">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gcr_image_repo: &#34;gcr.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">kube_image_repo: &#34;k8s.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">docker_image_repo: &#34;docker.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">quay_image_repo: &#34;quay.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">github_image_repo: &#34;ghcr.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">files_repo: &#34;https://files.m.daocloud.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="docker-部署">docker 部署</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -it --mount <span style="color:#008080">type</span><span style="color:#000;font-weight:bold">=</span>bind,source<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;</span><span style="color:#000;font-weight:bold">$(</span><span style="color:#0086b3">pwd</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>/inventory/mycluster,dst<span style="color:#000;font-weight:bold">=</span>/inventory <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  quay.io/kubespray/kubespray:v2.24.1 bash
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="查看集群配置">查看集群配置</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-inventory -i /inventory/inventory.ini --list
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="运行部署">运行部署</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 要输入两次密码</span>
</span></span><span style="display:flex;"><span>ansible-playbook -i /inventory/inventory.ini cluster.yml --user k8s --ask-pass --become --ask-become-pass
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="扩容节点">扩容节点</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i /inventory/inventory.ini scale.yml <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --user<span style="color:#000;font-weight:bold">=</span>linuzb --ask-pass --become --ask-become-pass -b <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --limit<span style="color:#000;font-weight:bold">=</span>kube-node-114
</span></span></code></pre></td></tr></table>
</div>
</div><p>您可以使用&ndash;limit=NODE_NAME限制 Kubespray 以避免干扰集群中的其他节点。 在没有使用&ndash;limitplaybook会运行facts.yml刷新所有节点的fact缓存。</p>
<h4 id="缩容节点">缩容节点</h4>
<p>如果有节点不再需要了，我们可以将其移除集群，通常步骤是:</p>
<ul>
<li>1.<code>kubectl cordon NODE</code> 驱逐节点，确保节点上的服务飘到其它节点上去，参考<a href="https://imroc.cc/kubernetes/best-practices/ops/securely-maintain-or-offline-node.html">安全维护或下线节点</a>。</li>
<li>2.停止节点上的一些 k8s 组件 (kubelet, kube-proxy) 等。</li>
<li>3.kubectl delete NODE 将节点移出集群。</li>
<li>4.如果节点是虚拟机，并且不需要了，可以直接销毁掉。</li>
</ul>
<p>前3个步骤，也可以用 kubespray 提供的<code>remove-node.yml</code>这个 playbook 来一步到位实现:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ansible-playbook <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -i inventory/mycluster/inventory.ini <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --user<span style="color:#000;font-weight:bold">=</span>linuzb --ask-pass --become --ask-become-pass -b <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -e <span style="color:#d14">&#34;node=kube-node-114&#34;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  remove-node.yml
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>-e</code> 里写要移出的节点名列表，如果您要删除的节点不在线，您应该将<code>reset_nodes=false</code>和添加<code>allow_ungraceful_removal=true</code>到您的额外变量中</p>
<h3 id="后续">后续</h3>
<h4 id="获取kubeconfig">获取kubeconfig</h4>
<p>部署完成后，可以在master节点上的 /root/.kube/config 路径获取到 kubeconfig</p>
<p>获取到kubeconfig后，将 https://127.0.0.1:6443 修改成kube-apiserver负载均衡器的地址:端口,或者其中一台master。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0086b3">alias</span> <span style="color:#008080">k</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;kubectl --kubeconfig /home/linuzb/Projects/kube-cert/kubeconfig&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nvidia-container">nvidia container</h4>
<ul>
<li><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#configuring-docker">Installing the NVIDIA Container Toolkit — NVIDIA Container Toolkit 1.14.5 documentation</a></li>
<li><a href="https://github.com/NVIDIA/nvidia-container-toolkit">NVIDIA/nvidia-container-toolkit: Build and run containers leveraging NVIDIA GPUs (github.com)</a></li>
</ul>
<h2 id="debug">debug</h2>
<h3 id="网络排查">网络排查</h3>
<h4 id="dns-问题排查">dns 问题排查</h4>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/">Debugging DNS Resolution | Kubernetes</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>dnsutils<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>dnsutils<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#000080">image</span>:<span style="color:#bbb"> </span>lunettes/lunettes:v0.1.5<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic"># image: registry.cn-hangzhou.aliyuncs.com/linuzb/jessie-dnsutils:1.3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">command</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- sleep<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d14">&#34;infinity&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000080">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">restartPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="apiserver-连通性">apiserver 连通性</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008080">KUBE_TOKEN</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -vvsSk -H <span style="color:#d14">&#34;Authorization: Bearer </span><span style="color:#008080">$KUBE_TOKEN</span><span style="color:#d14">&#34;</span> https://<span style="color:#008080">$KUBERNETES_SERVICE_HOST</span>:<span style="color:#008080">$KUBERNETES_SERVICE_PORT</span>/api/v1/namespaces/jhub/pods
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -sSk -H <span style="color:#d14">&#34;Authorization: Bearer </span><span style="color:#008080">$KUBE_TOKEN</span><span style="color:#d14">&#34;</span> https://172.16.0.100:6443/api/v1/namespaces/jhub/pods
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nodelocaldns">nodelocaldns</h4>
<p>kubernetes 节点重启后，nodelocaldns crash</p>
<p>原因：<a href="https://coredns.io/plugins/loop/#troubleshooting">loop (coredns.io)</a></p>
<p>解决方案
参考 <a href="https://github.com/kubernetes-sigs/kubespray/issues/9948">NodeLocalDNS Loop detected for zone &ldquo;.&rdquo; · Issue #9948 · kubernetes-sigs/kubespray (github.com)</a></p>
<p>删除coredns <a href="https://blog.csdn.net/u013007181/article/details/129731938">重置和重新安装kubernetes中的coreDNS_如何删除现在有的coredns-CSDN博客</a></p>
<blockquote>
<ol>
<li>Change settings in k8 config file for kubespray. I changed 2 things: <code>resolvconf_mode: none</code> and <code>remove_default_searchdomains: false</code></li>
</ol>
</blockquote>
<p>然后使用 kubespray 重新部署 kubernetes</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://www.sundayhk.com/post/kubespray/">使用Kubespray 部署Kubernetes集群 | Sunday博客 | Sunday Blog (sundayhk.com)</a></li>
<li><a href="https://k8s.huweihuang.com/project/setup/installer/install-k8s-by-kubespray">使用kubespray安装kubernetes | kubernetes-notes (huweihuang.com)</a></li>
</ul>
<p>也可参考其它方式 <a href="https://github.com/easzlab/kubeasz">easzlab/kubeasz: 使用Ansible脚本安装K8S集群</a></p>


    </div>
    <nav class="hide-on-mobile section-nav">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#准备">准备</a></li>
    <li><a href="#kubespray-配置">kubespray 配置</a>
      <ol>
        <li><a href="#自定义配置">自定义配置</a></li>
        <li><a href="#docker-部署">docker 部署</a></li>
        <li><a href="#后续">后续</a></li>
      </ol>
    </li>
    <li><a href="#debug">debug</a>
      <ol>
        <li><a href="#网络排查">网络排查</a></li>
      </ol>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ol>
</nav>
    </nav>
</div>
<div class="post">
    <hr class="footer-separator" />
<div class="tags">
    
    
    <ul class="flat">
        
        
        <li class="tag-li"><a href="/tags/kubernetes">Kubernetes</a>
        </li>
        
        
        <li class="tag-li"><a href="/tags/kubespray">Kubespray</a>
        </li>
        
    </ul>
    
    
</div>


<div class="back">
    <a href="https://github.com/linuzb/linuzb-blog/blob/master/content/posts/kubespray-deploy-k8s.md" title="github"><i
            data-feather="github"></i> Edit this on GitHub</a>
</div>


<div class="back">
    <a href="https://linuzb.github.io/"><span aria-hidden="true">← Back</span></a>
</div>


<div class="back">
    
    
    Next time, we'll talk about <i>"What Tiger King can teach us about x86 Assembly"</i>
    
    
</div>

</div>

	</div>
	

	<div class="footer wrapper">
	<nav class="nav">
		<div>2024  © Copyright notice </div>
		
	</nav>
</div><script>feather.replace()</script>
	
	<script>
    var enableTruncate =  true 
    var filterDepth = false;
    const MAX_DEPTH = 9; 

    
    window.addEventListener('DOMContentLoaded', () => {
        const observerForTableOfContentActiveState = new IntersectionObserver(entries => {
            entries.reverse().forEach(entry => {
                const id = entry.target.getAttribute('id');
                if (entry.intersectionRatio > 0) {
                    var selected = document.querySelectorAll(`nav li a[href="#${id}"]`)
                    if (selected != null) {
                        selected.forEach(s => {
                            if (s != null) {
                                var depth = getDepth(s.parentElement);
                                if (filterDepth && depth <= MAX_DEPTH) {
                                    clearActiveStatesInTableOfContents();
                                    s.parentElement.classList.add('active')
                                }
                            } else if (!filterDepth) {
                                clearActiveStatesInTableOfContents();
                                s.parentElement.classList.add('active');
                            }
                        }
                        )
                    }

                }
            });
        });
        document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach((section) => {
            observerForTableOfContentActiveState.observe(section);
        });

    });

    
    function isVisible(elem) {
        if (!(elem instanceof Element)) return false; 
        const style = getComputedStyle(elem);
        if (style.display === 'none') return false;
        if (style.visibility !== 'visible') return false;
        if (style.opacity < 0.1) return false;
        if (elem.offsetWidth + elem.offsetHeight + elem.getBoundingClientRect().height +
            elem.getBoundingClientRect().width === 0) {
            return false;
        }
        const elemCenter = {
            x: elem.getBoundingClientRect().left + elem.offsetWidth / 2,
            y: elem.getBoundingClientRect().top + elem.offsetHeight / 2
        };
        if (elemCenter.x < 0) return false;
        if (elemCenter.x > (document.documentElement.clientWidth || window.innerWidth)) return false;
        if (elemCenter.y < 0) return false;
        if (elemCenter.y > (document.documentElement.clientHeight || window.innerHeight)) return false;
        let pointContainer = document.elementFromPoint(elemCenter.x, elemCenter.y);
        do {
            if (pointContainer === elem) return true;
        } while (pointContainer = pointContainer.parentNode);
        return false;
    }


    function clearActiveStatesInTableOfContents() {
        document.querySelectorAll('nav li').forEach((section) => {
            section.classList.remove('active');
        });
    }

    function getDepth(parentElement) {
        var depth = 0;
        while (parentElement !== null && parentElement.tagName.toLowerCase() !== 'ul') {
            depth++;
            parentElement = parentElement.parentElement;
        }
        return depth;
    }

    function navItems() {
        
        var nestedListItems = document.querySelectorAll('nav nav li a');
        return Array.from(nestedListItems).filter(listItem =>
            listItem.href != null && listItem.hash.startsWith("#")
        )
    }

    function lasItemInNavBarVisible() {
        var lastItem = navItems().slice(-1)[0]
        return isVisible(lastItem)
    }


    
    document.addEventListener('DOMContentLoaded', function () {
        if (!enableTruncate) return;
        var navBar = navItems()
        console.log(navBar)
        if (!lasItemInNavBarVisible()) {
            filterDepth = true;
            
            navBar.forEach(function (listItem) {
                var depth = getDepth(listItem.parentElement);

                if (depth > MAX_DEPTH) {
                    listItem.parentElement.classList.add('depth-nested');
                }
            });
        }

    });

</script>

	
</body>

</html>
